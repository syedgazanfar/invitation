// Prisma schema for Wedding Invitations Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Organizers who create wedding events
model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  passwordHash       String   @map("password_hash")
  preferredCountry   String   @default("US") @map("preferred_country")
  preferredCurrency  String   @default("USD") @map("preferred_currency")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  events             Event[]
  refreshTokens      RefreshToken[]

  @@map("users")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Pricing plans - seeded data
model Plan {
  id               String   @id @default(uuid())
  code             PlanCode @unique
  name             String
  basePriceUsd     Decimal  @map("base_price_usd") @db.Decimal(10, 2)
  maxRegularGuests Int      @map("max_regular_guests")
  maxTestGuests    Int      @map("max_test_guests")
  createdAt        DateTime @default(now()) @map("created_at")

  events           Event[]
  templates        Template[]

  @@map("plans")
}

enum PlanCode {
  BASIC
  PREMIUM
  LUXURY
}

// Country-specific pricing configuration - seeded data
model CountryPricing {
  id           String   @id @default(uuid())
  countryCode  String   @unique @map("country_code")
  countryName  String   @map("country_name")
  currency     String
  exchangeRate Decimal  @map("exchange_rate") @db.Decimal(10, 4)
  multiplier   Decimal  @default(1.0) @db.Decimal(5, 2)
  taxRate      Decimal  @map("tax_rate") @db.Decimal(5, 2)
  serviceFee   Decimal  @map("service_fee") @db.Decimal(10, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("country_pricing")
}

// Wedding invitation templates - seeded data
model Template {
  id          String   @id
  planCode    PlanCode @map("plan_code")
  name        String
  previewUrl  String   @map("preview_url")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  plan        Plan     @relation(fields: [planCode], references: [code])
  events      Event[]

  @@map("templates")
}

// Wedding events created by users
model Event {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  planCode      PlanCode    @map("plan_code")
  templateId    String      @map("template_id")

  // Wedding details
  brideName     String      @map("bride_name")
  groomName     String      @map("groom_name")
  weddingDate   DateTime    @map("wedding_date") @db.Date
  startTime     String      @map("start_time")
  timezone      String      @default("UTC")

  // Venue details
  venueName     String      @map("venue_name")
  address       String
  city          String
  country       String
  lat           Decimal?    @db.Decimal(10, 7)
  lng           Decimal?    @db.Decimal(10, 7)

  // Optional message
  message       String?     @db.Text

  // Event lifecycle
  status        EventStatus @default(DRAFT)
  slug          String?     @unique
  activatedAt   DateTime?   @map("activated_at")
  expiresAt     DateTime?   @map("expires_at")

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan        @relation(fields: [planCode], references: [code])
  template      Template    @relation(fields: [templateId], references: [id])
  guests        Guest[]
  payment       Payment?

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@map("events")
}

enum EventStatus {
  DRAFT
  ACTIVE
  EXPIRED
}

// Payment records - stubbed for now
model Payment {
  id              String        @id @default(uuid())
  eventId         String        @unique @map("event_id")
  amount          Decimal       @db.Decimal(10, 2)
  currency        String
  countryCode     String        @map("country_code")
  status          PaymentStatus @default(PENDING)
  paymentMethod   String?       @map("payment_method")
  transactionId   String?       @unique @map("transaction_id")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Guest records - people who view invitations
model Guest {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  guestName   String   @map("guest_name")
  isTest      Boolean  @default(false) @map("is_test")
  userAgent   String?  @map("user_agent")
  ip          String?

  createdAt   DateTime @default(now()) @map("created_at")

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([isTest])
  @@map("guests")
}
